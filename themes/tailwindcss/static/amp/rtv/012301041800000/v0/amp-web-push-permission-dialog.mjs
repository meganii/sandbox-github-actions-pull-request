;
(()=>{var t,{hasOwnProperty:i,toString:s}=Object.prototype,e=/(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;function n(t,i=""){try{return decodeURIComponent(t)}catch(t){return i}}function o(t){return t.data}function r(i,s){return t||(t=self.document.createElement("a")),function(t,i,s){return t.href="",new URL(i,t.href)}(t,i)}self.__AMP_LOG=self.__AMP_LOG||{user:null,dev:null,userForEmbed:null},self.__AMP_LOG,new Set(["c","v","a","ad"]);var h=class{constructor(t){t||(t={debug:!1,windowContext:window}),this.Z={},this.te={},this.ee=t.debug,this.ne=!1,this.re=!1,this.ie=!1,this.se=null,this.oe=null,this.ce=null,this.ue=null,this.le=null,this.he=t.windowContext||window}listen(t){return new Promise(((i,s)=>{this.ie?s(new Error("Already connected.")):this.ne?s(new Error("Already listening for connections.")):Array.isArray(t)?(this.ce=this.ae.bind(this,t,i,s),this.he.addEventListener("message",this.ce),this.ee):s(new Error("allowedOrigins should be a string array of allowed origins to accept messages from. Got:",t))})).then((()=>{this.send(h.Topics.CONNECT_HANDSHAKE,null),this.ie=!0}))}fe(t,i){const s=r(t).origin;for(let t=0;t<i.length;t++)if(r(i[t]).origin===s)return!0;return!1}ae(t,i,s,e){const n=o(e),{origin:r,ports:c}=e;this.ee,this.fe(r,t)&&n&&n.topic===h.Topics.CONNECT_HANDSHAKE&&(this.he.removeEventListener("message",this.ce),this.oe=c[0],this.le=this.de.bind(this),this.oe.addEventListener("message",this.le,!1),this.oe.start(),i())}connect(t,i){return new Promise(((s,e)=>{t||e(new Error("Provide a valid Window context to connect to.")),i||e(new Error("Provide an expected origin for the remote Window or provide the wildcard *.")),this.ie?e(new Error("Already connected.")):this.re?e(new Error("Already connecting.")):(this.se=new MessageChannel,this.oe=this.se.port1,this.ue=this.ge.bind(this,this.oe,i,s),this.oe.addEventListener("message",this.ue),this.oe.start(),t.postMessage({topic:h.Topics.CONNECT_HANDSHAKE},"*"===i?"*":r(i).origin,[this.se.port2]))}))}ge(t,i,s){this.ie=!0,this.ee,t.removeEventListener("message",this.ue),this.le=this.de.bind(this),t.addEventListener("message",this.le,!1),s()}static get Topics(){return{CONNECT_HANDSHAKE:"topic-connect-handshake",NOTIFICATION_PERMISSION_STATE:"topic-notification-permission-state",SERVICE_WORKER_STATE:"topic-service-worker-state",SERVICE_WORKER_REGISTRATION:"topic-service-worker-registration",SERVICE_WORKER_QUERY:"topic-service-worker-query",STORAGE_GET:"topic-storage-get"}}de(t){const i=o(t);if(this.Z[i.id]&&i.isReply){const t=this.Z[i.id];delete this.Z[i.id];const{promiseResolver:s}=t;t.message=i.data,this.ee,s([i.data,this.pe.bind(this,i.id,t.topic)])}else{const t=this.te[i.topic];if(!t)return;this.ee;for(let s=0;s<t.length;s++)(0,t[s])(i.data,this.pe.bind(this,i.id,i.topic))}}on(t,i){this.te[t]?this.te[t].push(i):this.te[t]=[i]}off(t,i){if(i){const s=this.te[t].indexOf(i);-1!==s&&this.te[t].splice(s,1)}else this.te[t]&&delete this.te[t]}pe(t,i,s){const e={id:t,topic:i,data:s,isReply:!0};return this.oe.postMessage(e),new Promise((t=>{this.Z[e.id]={message:s,topic:i,promiseResolver:t}}))}send(t,i){const s={id:crypto.getRandomValues(new Uint8Array(10)).join(""),topic:t,data:i};return this.ee,this.oe.postMessage(s),new Promise((e=>{this.Z[s.id]={message:i,topic:t,promiseResolver:e}}))}};window._ampWebPushPermissionDialog=new class{constructor(t){this.ee=t&&t.debug,this.he=t.windowContext||window,this.ve=new h({debug:this.ee,windowContext:this.he})}isCurrentDialogPopup(){return!!this.he.opener&&this.he.opener!==this.he}requestNotificationPermission(){return new Promise(((t,i)=>{try{this.he.Notification.requestPermission((i=>t(i)))}catch(t){i(t)}}))}run(){this.tw(),this.iw(),this.sw(),this.ew(),"denied"!==this.he.Notification.permission?this.nw():this.ow()}tw(){const t=this.he.document.querySelector("#close");t&&t.addEventListener("click",(()=>{this.closeDialog()}))}closeDialog(){if(this.isCurrentDialogPopup())this.he.close();else{const t=function(t){const i=function(t){const i=Object.create(null);return i}();if(!t)return i;let s;for(;s=e.exec(t);){const t=n(s[1],s[1]),e=s[2]?n(s[2].replace(/\+/g," "),s[2]):"";i[t]=e}return i}((this.he.fakeLocation||this.he.location).search);if(!t.return)throw new Error("Missing required parameter.");const i=n(t.return);this.redirectToUrl(i)}}ow(){navigator.permissions.query({name:"notifications"}).then((t=>{t.onchange=()=>{switch(this.iw(),this.he.Notification.permission){case"default":case"granted":this.nw()}}}))}iw(){this.he.localStorage.setItem("amp-web-push-notification-permission",this.he.Notification.permission)}sw(){const t=this.he.document.querySelectorAll("[permission]");for(let i=0;i<t.length;i++){const s=t[i];this.rw(s,!1)}const i=this.he.document.querySelector(`[permission=${s=this.he.Notification.permission,CSS.escape(s)}]`);var s;i&&this.rw(i,!0)}ew(){const t=this.he.document.querySelector("#preload"),i=this.he.document.querySelector("#postload");t&&i&&(this.rw(t,!1),this.rw(i,!0))}rw(t,i){if(!t)return;const s="invisible";i?t.classList.remove(s):t.classList.add(s)}nw(){return this.requestNotificationPermission().then((t=>{if(this.iw(),this.isCurrentDialogPopup())return this.ve.connect(opener,"*"),this.ve.send(h.Topics.NOTIFICATION_PERMISSION_STATE,t).then((t=>{const i=t[0];i&&i.closeFrame&&this.closeDialog()}));this.closeDialog()}))}redirectToUrl(t){const i=r(t);!i||"http:"!==i.protocol&&"https:"!==i.protocol||(this.he.location.href=t)}}({debug:!1}),window._ampWebPushPermissionDialog.run()})();
/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */
//# sourceMappingURL=amp-web-push-permission-dialog.mjs.map