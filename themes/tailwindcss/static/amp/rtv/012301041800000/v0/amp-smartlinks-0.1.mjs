;
(self.AMP=self.AMP||[]).push({m:1,v:"2301041800000",n:"amp-smartlinks",ev:"0.1",l:!0,f:function(t,n){(()=>{var n="load-start",{isArray:i}=Array,{hasOwnProperty:s,toString:e}=Object.prototype;function r(t){return(t.ownerDocument||t).defaultView}function o(t,n,i){return function(t,n){for(const i in n)t.setAttribute(i,n[i]);return t}(t.createElement(n),i)}self.__AMP_LOG=self.__AMP_LOG||{user:null,dev:null,userForEmbed:null};var h,u=self.__AMP_LOG;function c(t){return function(t,n){throw new Error("failed to call initLogConstructor")}()}function l(t,n,i,s,e,r,o,h,u,c,l){return t}function a(){return h||(h=Promise.resolve(void 0))}function _(t,n){return A(t=function(t){return t.__AMP_TOP||(t.__AMP_TOP=t)}(t),n)}function f(t,n){return A(m(P(t)),n)}function p(t,n){return function(t,n){const i=k(t,n);if(i)return i;const s=v(t);return s[n]=function(){const t=new class{constructor(){this.promise=new Promise(((t,n)=>{this.resolve=t,this.reject=n}))}},{promise:n,reject:i,resolve:s}=t;return n.catch((()=>{})),{obj:null,promise:n,resolve:s,reject:i,context:null,ctor:null}}(),s[n].promise}(m(t),n)}function d(t,n){return k(m(t),n)}function P(t){return t.nodeType?(n=r(t),_(n,"ampdoc")).getAmpDoc(t):t;var n}function m(t){const n=P(t);return n.isSingleDoc()?n.win:n}function A(t,n){l(function(t,n){const i=t.__AMP_SERVICES&&t.__AMP_SERVICES[n];return!(!i||!i.ctor)}(t,n));const i=v(t)[n];return i.obj||(l(i.ctor),l(i.context),i.obj=new i.ctor(i.context),l(i.obj),i.context=null,i.resolve&&i.resolve(i.obj)),i.obj}function k(t,n){const i=v(t)[n];return i?i.promise?i.promise:(A(t,n),i.promise=Promise.resolve(i.obj)):null}function v(t){let n=t.__AMP_SERVICES;return n||(n=t.__AMP_SERVICES={}),n}var I=t=>function(t,n,i,s){const e=d(t,n);if(e)return e;const r=P(t);return r.whenExtensionsKnown().then((()=>{const t=r.getExtensionVersion(i);return t?_(r.win,"extensions").waitForExtension(i,t):null})).then((i=>i?p(t,n):null))}(t,"amp-analytics-instrumentation","amp-analytics");function T(t){return t.data}var E="https://api.narrativ.com/api",g={PAGE_IMPRESSION_ENDPOINT:`${E}/v1/events/impressions/page_impression/`,NRTV_CONFIG_ENDPOINT:`${E}/v0/publishers/.nrtv_slug./amp_config/`,LINKMATE_ENDPOINT:`${E}/v1/publishers/.pub_id./linkmate/smart_links/`},R=class{constructor(t,n){this.syncResponse=t,this.asyncResponse=n}};function w(t){return t.getAttribute("nrtv-account-name").toLowerCase()}function b(t){return!!t.hasAttribute("linkmate")}function M(t){return!!t.hasAttribute("exclusive-links")}function V(t){const n=t.getAttribute("link-attribute");return n?n.toLowerCase():"href"}function y(t){const n=t.getAttribute("link-selector");return n?n.toLowerCase():"a"}var L,N=(new Set(["c","v","a","ad"]),0),x="data-link-rewriter-original-url",U=["Webkit","webkit","Moz","moz","ms","O","o"];function C(t,n,i,s,e){const r=function(t,n,i){if(n.startsWith("--"))return n;L||(L=Object.create(null));let s=L[n];if(!s||i){if(s=n,void 0===t[n]){const i=function(t){return t.charAt(0).toUpperCase()+t.slice(1)}(n),e=function(t,n){for(let i=0;i<U.length;i++){const s=U[i]+n;if(void 0!==t[s])return s}return""}(t,i);void 0!==t[e]&&(s=e)}i||(L[n]=s)}return s}(t.style,n,e);if(!r)return;const o=s?i+s:i;t.style.setProperty(function(t){const n=t.replace(/[A-Z]/g,(t=>"-"+t.toLowerCase()));return U.some((t=>n.startsWith(t+"-")))?`-${n}`:n}(r),o)}var O=!1,S=/nochunking=1/.test(self.location.hash),j=a();var D="not_run",$=class{constructor(t){this.state=D,this.hs=t}os(t){if("run"!=this.state){this.state="run";try{this.hs(t)}catch(t){throw this.us(t),t}}}ls(){return this.hs.displayName||this.hs.name}us(t){}cs(){return!1}ds(){return!1}},q=class extends ${constructor(t,n,i){super(t),this.fs=i}us(t){var n;l((n=self.document).defaultView),O||(O=!0,function(t){!function(t,n){for(const i in n)C(t,i,n[i])}(t.body,{opacity:1,visibility:"visible","animation":"none"})}(n))}cs(){return this.ps()}ds(){return this.fs._s}ps(){return this.fs.ampdoc.isVisible()}},F=class{constructor(t){var n;this.ampdoc=t,this.i=t.win,this.As=new class{constructor(){this.es=[]}peek(){const t=this.length;return t?this.es[t-1].item:null}enqueue(t,n){if(isNaN(n))throw new Error("Priority must not be NaN.");const i=this.ns(n);this.es.splice(i,0,{item:t,priority:n})}ns(t){let n=-1,i=0,s=this.length;for(;i<=s&&(n=Math.floor((i+s)/2),n!==this.length);)if(this.es[n].priority<t)i=n+1;else{if(!(n>0&&this.es[n-1].priority>=t))break;s=n-1}return n}forEach(t){let n=this.length;for(;n--;)t(this.es[n].item)}dequeue(){const t=this.es.pop();return t?t.item:null}get length(){return this.es.length}},this.gs=this.Ps.bind(this),this.vs=0,this.Es=!(!this.i.navigator.scheduling||!this.i.navigator.scheduling.isInputPending),this.Ts=!1,this.rs=this.i.document.documentElement.hasAttribute("i-amphtml-no-boilerplate"),this.i.addEventListener("message",(t=>{"amp-macro-task"==T(t)&&this.Ps(null)})),this._s=!1,(n=t,p(n,"viewer")).then((()=>{this._s=!0})),t.onVisibilityChanged((()=>{t.isVisible()&&this.Is()}))}run(t,n){const i=new $(t);this.Ms(i,n)}runForStartup(t){const n=new q(t,this.i,this);this.Ms(n,Number.POSITIVE_INFINITY)}Ms(t,n){this.As.enqueue(t,n),this.Is()}Rs(t){let n=this.As.peek();for(;n&&n.state!==D;)this.As.dequeue(),n=this.As.peek();return n&&t&&this.As.dequeue(),n}Ps(t){const n=this.Rs(!0);if(!n)return this.Ts=!1,this.vs=0,!1;let i;try{i=Date.now(),n.os(t)}finally{j.then().then().then().then().then().then().then().then().then((()=>{this.Ts=!1,this.vs+=Date.now()-i,this.Is()}))}return!0}ys(t){if(this.rs&&(this.Es?this.i.navigator.scheduling.isInputPending():this.vs>5))return this.vs=0,void this.ws();j.then((()=>{this.gs(t)}))}Is(){if(this.Ts)return;const t=this.Rs();return t?t.cs()?(this.Ts=!0,void this.ys(null)):void(t.ds()&&this.i.requestIdleCallback?function(t,n,i,s){const e=Date.now();t.requestIdleCallback((function n(i){if(i.timeRemaining()<15){const r=2e3-(Date.now()-e);r<=0||i.didTimeout?s(i):t.requestIdleCallback(n,{timeout:r})}else s(i)}),{timeout:2e3})}(this.i,0,0,this.gs):this.ws()):void 0}ws(){this.i.postMessage("amp-macro-task","*")}},G=class extends t.BaseElement{constructor(t){super(t),this.f$=null,this.tU=null,this.iU=null,this.t3=null,this.n3=null,this.i3=null,this.uU=null}buildCallback(){this.tU=this.getAmpDoc(),this.f$=_(this.tU.win,"xhr");const t=f(this.tU,"viewer");var n;return this.n3={nrtvSlug:w(n=this.element),linkmateEnabled:b(n),exclusiveLinks:M(n),linkAttribute:V(n),linkSelector:y(n)},this.iU=new class{constructor(t){var n;this.od=t.getRootNode(),this.hU=this.aU(t),this.lU=[],this.fU(this.od),(n=t,f(n,"navigation")).registerAnchorMutator(this.maybeRewriteLink.bind(this),N)}registerLinkRewriter(t,n,i){const s=new class{constructor(t,n,i,s){this.events=new class{constructor(){this.Fn=null}add(t){return this.Fn||(this.Fn=[]),this.Fn.push(t),()=>{this.remove(t)}}remove(t){this.Fn&&function(t,n){const i=t.indexOf(n);-1!=i&&t.splice(i,1)}(this.Fn,t)}removeAll(){this.Fn&&(this.Fn.length=0)}fire(t){if(this.Fn)for(const n of this.Fn.slice())n(t)}getHandlerCount(){var t,n;return null!==(t=null===(n=this.Fn)||void 0===n?void 0:n.length)&&void 0!==t?t:0}},this.id=n,this.od=t,this.dU=i,this._U=s.linkSelector||"a",this.pU=300,this.mU=new class{constructor(){this.AU=[],this.kU=[]}updateLinkList(t){this.kU=t.map(this.getReplacementUrlForAnchor.bind(this)),this.AU=t}updateReplacementUrls(t){t.forEach((t=>{const{anchor:n,replacementUrl:i}=t,s=this.AU.indexOf(n);-1!==s&&(this.kU[s]=i)}))}getReplacementUrlForAnchor(t){const n=this.AU.indexOf(t);return-1!==n?this.kU[n]:null}isInCache(t){return-1!==this.AU.indexOf(t)}getAnchorReplacementList(){return this.AU.map((t=>({anchor:t,replacementUrl:this.getReplacementUrlForAnchor(t)})))}}}getReplacementUrl(t){return this.isWatchingLink(t)?this.mU.getReplacementUrlForAnchor(t):null}getAnchorReplacementList(){return this.mU.getAnchorReplacementList()}isWatchingLink(t){return this.mU.isInCache(t)}rewriteAnchorUrl(t){const n=this.getReplacementUrl(t);return!(!n||n===t.href||(t.setAttribute(x,t.href),t.href=n,setTimeout((()=>{t.href=t.getAttribute(x),t.removeAttribute(x)}),this.pU),0))}onDomUpdated(){return new Promise((t=>{!function(t,n,i){if(S)return void j.then(n);const s=function(t){return function(t,n,i,s){const e=P(t);!function(t,n,i,s,e,r){const o=v(t);let h=o[i];h||(h=o[i]={obj:null,promise:null,resolve:null,reject:null,context:null,ctor:null,sharedInstance:!1}),h.ctor||(h.ctor=s,h.context=n,h.sharedInstance=!1,h.resolve&&A(t,i))}(m(e),e,n,i)}(t,"chunk",F),f(t,"chunk")}(t);s.run(n,i)}(this.od.nodeType==Node.DOCUMENT_NODE?this.od.documentElement:this.od,(()=>this.PU().then((()=>{this.events.fire({type:"PAGE_SCANNED"}),t()}))),10)}))}PU(){const t=this.gU(),n=this.IU(t);if(this.mU.updateLinkList(t),!n.length)return a();this.mU.updateReplacementUrls(n.map((t=>({anchor:t,replacementUrl:null}))));const i=this.dU(n);return s=i instanceof R,'Invalid response from provided "resolveUnknownLinks" function."resolveUnknownLinks" should return an instance of TwoStepsResponse',(u.user||(u.user=c()),void u.user.win?u.userForEmbed||(u.userForEmbed=c()):u.user).assert(s,'Invalid response from provided "resolveUnknownLinks" function."resolveUnknownLinks" should return an instance of TwoStepsResponse',undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined,undefined),i.syncResponse&&this.mU.updateReplacementUrls(i.syncResponse),i.asyncResponse?i.asyncResponse.then((t=>{this.mU.updateReplacementUrls(t)})):a();var s}IU(t){const n=[];return t.forEach((t=>{this.isWatchingLink(t)||n.push(t)})),n}gU(){const t=this.od.querySelectorAll(this._U);return[].slice.call(t)}}(this.od,t,n,i);return this.TU(this.lU,s,this.hU),s.onDomUpdated(),s}maybeRewriteLink(t,n){const i=this.vU(t);if(i.length){let s=null;for(let n=0;n<i.length;n++)if(i[n].rewriteAnchorUrl(t)){s=i[n];break}const e={linkRewriterId:s?s.id:null,anchor:t,clickType:n.type};i.forEach((t=>{const n={type:"CLICK",eventData:e};t.events.fire(n)}))}}aU(t){const n=t.getMetaByName("amp-link-rewriter-priorities");return n?n.trim().split(/\s+/):[]}fU(t){t.addEventListener("amp:dom-update",this.wU.bind(this))}wU(){this.lU.forEach((t=>{t.onDomUpdated()}))}RU(t){const n=t.hasAttribute("data-link-rewriters")?t.getAttribute("data-link-rewriters").trim():null;return n?n.split(/\s+/):[]}TU(t,n,i){return t.push(n),t.sort(((t,n)=>{const s=i.indexOf(t.id),e=i.indexOf(n.id);return-1===s&&-1===e?0:-1===s?1:-1===e?-1:s>e?1:-1})),t}vU(t){const n=this.RU(t);return this.lU.reduce(((i,s)=>(s.isWatchingLink(t)&&this.TU(i,s,n),i)),[])}}(this.tU),this.tU.whenReady().then((()=>t.getReferrerUrl())).then((t=>{this.uU=t,this.tU.whenFirstVisible().then((()=>{this.s3()}))}))}s3(){this.e3().then((t=>{t&&(this.n3.linkmateExpected=t.linkmate_enabled,this.n3.publisherID=t.publisher_id,this.r3(),this.i3=new class{constructor(t,n,i,s){this.f$=n,this.o3=i.exclusiveLinks,this.h3=i.publisherID,this.u3=i.linkAttribute,this.AU=null,this.c3=null,this.i=s}runLinkmate(t){let n=null;const s=this.AU&&!function(t,n,s=5){if(!isFinite(s)||s<0)throw new Error("Invalid depth: "+s);if(t===n)return!0;const e=[{a:t,b:n,depth:s}];for(;e.length>0;){const{a:t,b:n,depth:s}=e.shift();if(s>0){if(typeof t!=typeof n)return!1;if(i(t)&&i(n)){if(t.length!==n.length)return!1;for(let i=0;i<t.length;i++)e.push({a:t[i],b:n[i],depth:s-1});continue}if(t&&n&&"object"==typeof t&&"object"==typeof n){const i=Object.keys(t),r=Object.keys(n);if(i.length!==r.length)return!1;for(const r of i)e.push({a:t[r],b:n[r],depth:s-1});continue}}if(t!==n)return!1}return!0}(this.AU,t);if(this.c3&&s&&(n=this.l3()),!this.c3||s){const i=this.a3(t).then((n=>(this.c3=T(n)[0].smart_links,this.AU=t,this.l3())));return new R(n,i)}return this.AU=t,new R(n,null)}a3(t){const n=this._3(t),i={"article":this.f3(),"links":n},s=g.LINKMATE_ENDPOINT.replace(".pub_id.",this.h3.toString()),e={method:"POST",ampCors:!1,headers:{"Content-Type":"application/json"},body:i};return this.f$.fetchJson(s,e).then((t=>t.json()))}_3(t){const n=[];return t.forEach((t=>{const i=t.getAttribute(this.u3);if(/shop-links.co/.test(i))/\?amp=true$/.test(i)||(t[this.u3]=`${t[this.u3]}?amp=true`);else if(!/#donotlink$/.test(i)){const t={"raw_url":i,"exclusive_match_requested":this.o3||/#locklink$/.test(i),"link_source":"linkmate"};n.push(t)}})),n}f3(){return{"name":this.d3(),"url":this.P3()}}d3(){let t=null;return this.i.document.getElementsByTagName("title").length>0&&(t=this.i.document.getElementsByTagName("title")[0].text),t}P3(){return this.i.location.href}l3(){const t=[];return this.AU.forEach((n=>{this.c3.forEach((i=>{n.getAttribute(this.u3)===i.url&&i.auction_id&&t.push({anchor:n,replacementUrl:`https://shop-links.co/${i.auction_id}/?amp=true`})}))})),t}}(this.tU,this.f$,this.n3,this.win),this.t3=this.m3(),this.n3.linkmateEnabled&&this.n3.linkmateExpected&&this.t3.getAnchorReplacementList())}))}e3(){const t=g.NRTV_CONFIG_ENDPOINT.replace(".nrtv_slug.",this.n3.nrtvSlug);try{return this.f$.fetchJson(t,{method:"GET",ampCors:!1}).then((t=>t.json())).then((t=>T(t)[0].amp_config))}catch(t){return null}}r3(){this.signals().signal(n);const t=this.A3(),s=new class{constructor(t){this.si=t,this.ZU={"requests":{},"triggers":{}}}setTransportConfig(t){this.ZU.transport=t}setExtraUrlParams(t){this.ZU.extraUrlParams=t}track(t,n){n=i(n)?n:[n],l(!this.ZU.triggers[t]);const s=[];for(let i=0;i<n.length;i++){const e=`${t}-request-${i}`;this.ZU.requests[e]=n[i],s.push(e)}return this.ZU.triggers[t]={"on":t,"request":s},this}build(){l(this.ZU);const t=new class{constructor(t,i){l(i.triggers),this.vi=t.getResourceId(),this.si=t,this.ZU=i;for(const t in i.triggers){const n=i.triggers[t].on;l(n);const s=this.HU(n);i.triggers[t].on=s}this.si.signals().whenSignal(n).then((()=>{!function(t,n,i=!1,s=!1){const e=t.ownerDocument,h=o(e,"amp-analytics",{"sandbox":"true","trigger":s?"":"immediate"}),u=o(e,"script",{"type":"application/json"});if(u.textContent=JSON.stringify(n),h.appendChild(u),h.CONFIG=n,i){const n=_(r(t),"extensions"),i=P(t);n.installExtensionForDoc(i,"amp-analytics")}else I(t).then((t=>{l(t)}));t.appendChild(h)}(this.si,i,!0)}))}trigger(t,n){l(this.ZU.triggers[t]),function(t,n,i={},s=!0){I(t).then((e=>{e&&e.triggerEventForTarget(t,n,i,s)}))}(this.si,this.HU(t),n,!1)}HU(t){return`sandbox-${this.vi}-${t}`}}(this.si,this.ZU);return this.ZU=null,t}}(this.element);s.track("page-impression",g.PAGE_IMPRESSION_ENDPOINT),s.setTransportConfig({"beacon":!0,"image":!1,"xhrpost":!0,"useBody":!0}),s.setExtraUrlParams(t),s.build().trigger("page-impression")}m3(){const t={linkSelector:this.n3.linkSelector};return this.iU.registerLinkRewriter("amp-smartlinks",(t=>this.i3.runLinkmate(t)),t)}A3(){return{"events":[{"is_amp":!0}],"organization_id":this.n3.publisherID,"organization_type":"publisher","user":{"page_session_uuid":this.v3(),"source_url":this.P3(),"previous_url":this.uU,"user_agent":this.tU.win.navigator.userAgent}}}P3(){return this.win.location.href}v3(){return([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(t=>(t^crypto.getRandomValues(new Uint8Array(1))[0]&15>>t/4).toString(16)))}};t.registerElement("amp-smartlinks",G)})();
/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */}});
//# sourceMappingURL=amp-smartlinks-0.1.mjs.map