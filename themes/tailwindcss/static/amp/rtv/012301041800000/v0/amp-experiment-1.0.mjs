;
(self.AMP=self.AMP||[]).push({m:1,v:"2301041800000",n:"amp-experiment",ev:"1.0",l:!1,f:function(t,n){(()=>{var{isArray:n}=Array,{hasOwnProperty:e,toString:r}=Object.prototype;function i(t){return"[object Object]"===r.call(t)}function o(t){const n=Object.create(null);return t&&Object.assign(n,t),n}function s(t,n){return e.call(t,n)}function u(t,n,e,r,i,o,s,u,c,a,l){return t}function c(t){return JSON.parse(t)}function a(t,n,e){return n in t?Object.defineProperty(t,n,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[n]=e,t}function l(t,n){var e=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(t,n).enumerable}))),e.push.apply(e,r)}return e}function f(t){for(var n=1;n<arguments.length;n++){var e=null!=arguments[n]?arguments[n]:{};n%2?l(Object(e),!0).forEach((function(n){a(t,n,e[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):l(Object(e)).forEach((function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(e,n))}))}return t}var h=/(?:^[#?]?|&)([^=&]+)(?:=([^&]*))?/g;function m(t,n=""){try{return decodeURIComponent(t)}catch(t){return n}}function p(t){const n=Object.getOwnPropertyDescriptor(t,"message");if(null!=n&&n.writable)return t;const{message:e,stack:r}=t,i=new Error(e);for(const n in t)i[n]=t[n];return i.stack=r,i}function d(t){let n=null,e="";for(const t of arguments)t instanceof Error&&!n?n=p(t):(e&&(e+=" "),e+=t);return n?e&&(n.message=e+": "+n.message):n=new Error(e),n}function v(t,...n){const e=d.apply(null,n);e.name=t||e.name,function(t){var n,e;null===(n=(e=self).__AMP_REPORT_ERROR)||void 0===n||n.call(e,t)}(e)}self.__AMP_LOG=self.__AMP_LOG||{user:null,dev:null,userForEmbed:null};var b,g=self.__AMP_LOG;function w(t){return g.user||(g.user=y()),function(t,n){return n&&n.ownerDocument.defaultView!=t}(g.user.win,t)?g.userForEmbed||(g.userForEmbed=y()):g.user}function y(t){return function(t,n){throw new Error("failed to call initLogConstructor")}()}function A(t,n,e,r,i,o,s,u,c,a,l){return t}function P(t,n,e,r,i,o,s,u,c,a,l){return w().assert(t,n,e,r,i,o,s,u,c,a,l)}function x(){return b||(b=Promise.resolve(void 0))}var O=class{constructor(){this.promise=new Promise(((t,n)=>{this.resolve=t,this.reject=n}))}};function j(t,n){return R(t=function(t){return t.__AMP_TOP||(t.__AMP_TOP=t)}(t),n)}function M(t,n){return R(I(E(t)),n)}function S(t,n){return function(t,n){const e=T(t,n);if(e)return e;const r=N(t);return r[n]=function(){const t=new O,{promise:n,reject:e,resolve:r}=t;return n.catch((()=>{})),{obj:null,promise:n,resolve:r,reject:e,context:null,ctor:null}}(),r[n].promise}(I(t),n)}function _(t,n){return T(I(t),n)}function E(t){return t.nodeType?(e=t,n=(e.ownerDocument||e).defaultView,j(n,"ampdoc")).getAmpDoc(t):t;var n,e}function I(t){const n=E(t);return n.isSingleDoc()?n.win:n}function R(t,n){A(k(t,n));const e=N(t)[n];return e.obj||(A(e.ctor),A(e.context),e.obj=new e.ctor(e.context),A(e.obj),e.context=null,e.resolve&&e.resolve(e.obj)),e.obj}function T(t,n){const e=N(t)[n];return e?e.promise?e.promise:(R(t,n),e.promise=Promise.resolve(e.obj)):null}function N(t){let n=t.__AMP_SERVICES;return n||(n=t.__AMP_SERVICES={}),n}function k(t,n){const e=t.__AMP_SERVICES&&t.__AMP_SERVICES[n];return!(!e||!e.ctor)}var $="__AMP__EXPERIMENT_TOGGLES";var V=t=>j(t,"crypto");function J(t){const n=new Uint8Array(t.length);for(let e=0;e<t.length;e++){const r=t.charCodeAt(e);u(r<=255),n[e]=r}return n}function C(t){const n=new Array(t.length);for(let e=0;e<t.length;e++)n[e]=String.fromCharCode(t[e]);return n.join("")}var U,L=(()=>self.AMP.config.urls)(),z=new Set(["c","v","a","ad"]),D=t=>"string"==typeof t?G(t):t;function G(t,n){return U||(U=self.document.createElement("a")),function(t,n,e){return t.href="",new URL(n,t.href)}(U,t)}var Q="OriginExperiments",W={"alg":"RS256","e":"AQAB","ext":!0,"key_ops":["verify"],"kty":"RSA","n":"uAGSMYKze8Fit508UaGHz1eZowfX4YsA0lmyi-65xQfjF7nMo61c4Iz4erdqgRp-ov662yVPquhPmTxgB-nzNcTPrj15Jo05Js78Q9hS2hrPIjKMlzcKSYQN_08QieWKOSmVbLSv_-4n9Ms5ta8nRs4pwc_2nX5n7m5B5GH4VerGbqIWIn9FRNYMShBRQ9TCHpb6BIUTwUn6iwmJLenq0A1xhGrQ9rswGC1QJhjotkeReKXZDLLWaFr0uRw-IyvRa5RiiEGntgOvcbvamM5TnbKavc2rxvg2TWTCNQnb7lWSAzldJA_yAOYet_MjnHMyj2srUdbQSDCk8kPWWuafiQ"};function F(t){!function(t,n,e,r){const i=E(t),o=I(i);!function(t,n,e,r,i,o){const s=N(t);let u=s[e];u||(u=s[e]={obj:null,promise:null,resolve:null,reject:null,context:null,ctor:null,sharedInstance:!1}),u.ctor||(u.ctor=r,u.context=n,u.sharedInstance=!1,u.resolve&&R(t,e))}(o,i,n,class{constructor(t){this.ji=t,this.yj=V(t.win),this.pi=function(t,n){const e=I(E(t));return k(e,"url")?R(e,"url"):null}(t.getHeadNode()),this.Aj=new class{constructor(t,n){this.yj=t,this.pi=n}generateKeys(){const t=f({modulusLength:2048,publicExponent:Uint8Array.of(1,0,1)},this.yj.pkcsAlgo);return this.yj.subtle.generateKey(t,!0,["sign","verify"])}generateToken(t,n,e){const r=J(JSON.stringify(n)),i=this.Pj(t,r);return this.xj(i,e).then((t=>this.Oj(i,new Uint8Array(t))))}verifyToken(t,n,e){return new Promise((r=>{let i=0;const o=J(atob(t)),s=o[i];if(0!==s)throw new Error(`Unrecognized token version: ${s}`);i+=1;const u=new DataView(o.buffer).getUint32(i);if(i+=4,u>o.length-i)throw new Error(`Unexpected config length: ${u}`);const a=o.subarray(i,i+u);i+=u;const l=o.subarray(0,i),f=o.subarray(i);r(this.jj(f,l,e).then((t=>{if(!t)throw new Error("Failed to verify token signature.");const e=c(C(a)),r=this.pi.parse(e.origin).origin,i=G(function(t){if(!function(t){return L.cdnProxyRegex.test(D(t).origin)}(t=D(t)))return t.href;const n=t.pathname.split("/"),e=n[1];P(z.has(e),"Unknown path prefix in url %s",t.href);const r=n[2],i="s"==r?"https://"+decodeURIComponent(n[3]):"http://"+decodeURIComponent(r);return P(i.indexOf(".")>0,"Expected a . in origin %s",i),n.splice(1,"s"==r?3:2),i+n.join("/")+function(t,n){if(!t||"?"==t)return"";const e=new RegExp("[?&](amp_(js[^&=]*|gsa|r|kit)|usqp)\\b[^&]*","g"),r=t.replace(e,"").replace(/^[?&]/,"");return r?"?"+r:""}(t.search)+(t.hash||"")}(n)).origin;if(r!==i)throw new Error(`Config origin (${r}) does not match window (${i}).`);const o=e.experiment;if(e.expiration>=Date.now())return o;throw new Error(`Experiment "${o}" has expired.`)})))}))}Pj(t,n){const e=new Uint8Array(n.length+5);return e[0]=t,new DataView(e.buffer).setUint32(1,n.length,!1),e.set(n,5),e}Oj(t,n){const e=C(t)+C(n);return btoa(e)}xj(t,n){return this.yj.subtle.sign(this.yj.pkcsAlgo,n,t)}jj(t,n,e){return this.yj.verifyPkcs(e,t,n)}}(this.yj,this.pi),this.Mj=null}getExperiments(t=!1,n=W){return this.yj.isPkcsAvailable()?(this.Mj&&!t||(this.Mj=this.Sj(n)),this.Mj):(w().error(Q,"Crypto is unavailable."),Promise.resolve([]))}Sj(t){const n=this.ji.getHeadNode().querySelectorAll('meta[name="amp-experiment-token"]');if(0==n.length)return x();const{win:e}=this.ji;return V(e).importPkcsKey(t).then((t=>{const r=[];for(let i=0;i<n.length;i++){const o=n[i],s=o.getAttribute("content");if(s){const n=this.Aj.verifyToken(s,e.location,t).catch((t=>{w().error(Q,"Failed to verify experiment token:",t)}));r.push(n)}else w().error(Q,"Missing content for experiment token: ",o)}return Promise.all(r)}))}})}(t,"origin-experiments")}var Y,B=["attributes","characterData","childList"];function K(t){const n=JSON.stringify(t);P(void 0!==t.value&&"string"==typeof t.value,"Mutation %s must have a value.",n),P(void 0!==t.attributeName&&"string"==typeof t.attributeName,"Mutation %s must have a attributeName.",n)}function q(t){const n=t.tagName;return n.startsWith("AMP-")&&!("AMP-STICKY-AD-TOP-PADDING"==n||"AMP-BODY"==n)}var H=["Webkit","webkit","Moz","moz","ms","O","o"];function X(t,n,e,r,i){const s=function(t,n,e){if(n.startsWith("--"))return n;Y||(Y=o());let r=Y[n];if(!r||e){if(r=n,void 0===t[n]){const e=function(t){return t.charAt(0).toUpperCase()+t.slice(1)}(n),i=function(t,n){for(let e=0;e<H.length;e++){const r=H[e]+n;if(void 0!==t[r])return r}return""}(t,e);void 0!==t[i]&&(r=i)}e||(Y[n]=r)}return r}(t.style,n,i);if(!s)return;const u=r?e+r:e;t.style.setProperty(function(t){const n=t.replace(/[A-Z]/g,(t=>"-"+t.toLowerCase()));return H.some((t=>n.startsWith(t+"-")))?`-${n}`:n}(s),u)}var Z=/\S/,tt=/.*/,nt={"color":tt,"background-color":tt,"visibility":/^hidden$/,"display":/^none$/,"position":/^(static|relative|absolute|initial|inherit)$/,"font-size":tt,"background-image":tt,"border-width":tt,"border-style":tt,"border-color":tt},et={"width":tt,"height":tt},rt=["AMP-IMG","AMP-IFRAME","A"],it="amp-experiment apply-experiment";var ot=/^[\w-]+$/;function st(t,n,e,r){ut(e),function(t,n){const e=n.variants;P(i(e)&&Object.keys(e).length>0,"Missing variants object from experiment."),n.group&&ut(n.group);let r=0;for(const n in e)if(s(e,n)){ut(n);const i=e[n];ct(i,t,n),r+=i.weight}P(r.toFixed(6)<=100,"Total percentage is bigger than 100: "+r)}(e,r);const o=t.getParam("amp-x-"+e);if(o&&s(r.variants,o))return Promise.resolve(o);const u=!1!==r.sticky,c=r.cidScope||"amp-experiment";let a=Promise.resolve(!0);var l;return u&&r.consentNotificationId&&(a=(l=t.getHeadNode(),function(t,n,e,r){return function(t,n,e,r){const i=_(t,n);if(i)return i;const o=E(t);return o.whenExtensionsKnown().then((()=>{const t=o.getExtensionVersion(e);return t?j(o.win,"extensions").waitForExtension(e,t):null})).then((e=>e?r?_(t,n):S(t,n):null))}(t,n,e,r).then((t=>function(t,n,e){return P(t,"Service %s was requested to be provided through %s, but %s is not loaded in the current page. To fix this problem load the JavaScript file for %s in this page.",n,e,e,e)}(t,n,e)))}(l,"userNotificationManager","amp-user-notification")).then((t=>t.getNotification(r.consentNotificationId))).then((t=>(P(t,`Notification not found: ${r.consentNotificationId}`),t.isDismissed())))),a.then((n=>{if(!n)return null;const i=r.group||e;return function(t,n,e){if(!e)return Promise.resolve(100*t.win.Math.random());const r=(i=t,S(i,"cid")).then((t=>t.get({scope:e,createCookieIfNotPresent:!0},x())));var i;return Promise.all([r,V(t.win)]).then((t=>t[1].uniform(n+":"+t[0]))).then((t=>100*t))}(t,i,u?c:null).then((t=>{let n=0;const e=r.variants,i=Object.keys(e).sort();for(let r=0;r<i.length;r++)if(n+=e[i[r]].weight,t<n)return i[r];return null}))}))}function ut(t){P(ot.test(t),"Invalid name: %s. Allowed chars are [a-zA-Z0-9-_].",t)}function ct(t,e,r){P(i(t),`${e}.variants.${r} must be an object.`),P(void 0!==t.weight&&"number"==typeof t.weight,`${e}.variants.${r} must have a number weight.`);const o=t.weight;P(o>0&&o<100,`Invalid weight percentage %s. ${e}.variants.${r} Has to be greater than 0 and less than 100`,o),P(t.mutations&&n(t.mutations),`${e}.variants.${r} must have a mutations array.`)}var at="amp-experiment",lt=class extends t.BaseElement{static prerenderAllowed(){return!0}isLayoutSupported(t){return"nodisplay"==t||"container"==t}isBuildRenderBlocking(){return!0}buildCallback(){const t=[S(this.getAmpDoc(),"variant"),this._j()];return Promise.all(t).then((t=>{const n=t[0],e=t[1];let r={};try{if(r=this.zA(),!e)return w().error(at,"Experiment amp-experiment-1.0 is not enabled."),void n.init(Promise.resolve(this.Ej(r)));const t=this.getAmpDoc();if(M(t,"viewer"),null!=t.getParam("amp-x-disable-all-experiments"))return void n.init(Promise.resolve(this.Ej(r)));const u=Object.create(null),c=Object.keys(r).map((n=>st(t,0,n,r[n]).then((t=>{u[n]=t}))));return Promise.all(c).then((()=>{const t=function(t,n,e){const r=function(t,n){let e=[];for(const r in n){const i=n[r];if(i){const n=t[r].variants[i];e=e.concat(n.mutations)}}return e}(n,e);return t.whenReady().then((()=>{const n=[];let e=0;if(r.forEach((r=>{!function(t){P(i(t),"Mutation %s must be an object.",JSON.stringify(t)),P(void 0!==t.type&&"string"==typeof t.type,"Mutation %s must have a type.",JSON.stringify(t)),P(B.indexOf(t.type)>=0,"Mutation %s must have a valid type.",JSON.stringify(t)),P(void 0!==t.target&&"string"==typeof t.target,"Mutation %s must have a target.",JSON.stringify(t))}(r);const o=function(t,n){const e=n.target;P(!e.match(/(^|\\W)i-amphtml-/),"target %s cannot select i-amphtml-",e);const r=t.querySelectorAll(e);return P(r.length>0,"No element on the document matches the selector, %s .",n.target),(i=r)?Array.prototype.slice.call(i):[];var i}(t.win.document,r);e+=o.length,n.push({mutationRecord:r,elements:o})})),e>70){const t=`Max number of mutations for the total applied experiments exceeded: ${e} > 70`;throw w().error(it,t),new Error(t)}const u=function(t){const n=[];return t.forEach((t=>{const{elements:e,mutationRecord:r}=t;let i;if("characterData"===r.type)i=new class{constructor(t,n){this.Ij=t,this.L=n,function(t){const n=JSON.stringify(t);P(void 0!==t.value&&"string"==typeof t.value,"Mutation %s must have a value.",n)}(this.Ij)}parseAndValidate(){return!0}mutate(){this.L.forEach((t=>{t.textContent=this.Ij.value}))}toString(){return JSON.stringify(this.Ij)}}(r,e);else if("attributes"===r.type)if("style"===r.attributeName)i=new class{constructor(t,n){this.Ij=t,this.L=n,this.Rj={},this.Tj=!1,K(this.Ij)}parseAndValidate(){const t=this.Ij.value;if(t.match(/(!\s*important|<)/))return!1;for(let t=0;t<this.L.length;t++)if(q(this.L[t])){this.Tj=!0;break}const n=t.split(";");for(let t=0;t<n.length;t++){if(!Z.test(n[t]))continue;const e=n[t].split(":");if(2!=e.length)return!1;const r=e[0].trim(),i=e[1].trim();if(!this.Nj(r,i))return w().error("amp-experiment/style","Unsupported style mutation property: %s, value: %s",r,i),!1;this.Rj[r]=i}return!0}mutate(){this.L.forEach((t=>{var n;!function(t,n){for(const e in n)X(t,e,n[e])}(t,(n=this.Rj,"display"in n&&v("STYLE","`display` style detected. You must use toggle instead."),n))}))}Nj(t,n){return!(this.Tj||!s(et,t)||!n.match(et[t]))||!!s(nt,t)&&!!n.match(nt[t])}toString(){return JSON.stringify(this.Ij)}}(r,e);else if("href"===r.attributeName||"src"===r.attributeName)i=new class{constructor(t,n){this.Ij=t,this.L=n,K(this.Ij)}parseAndValidate(){for(let t=0;t<this.L.length;t++){const n=this.L[t];if(rt.indexOf(n.tagName)<0)return!1}try{!function(t,n,e="source"){var r;P(null!=t,"%s %s must be available",n,e),P("https:"==(r=D(r=t)).protocol||"localhost"==r.hostname||"127.0.0.1"==r.hostname||function(t,n){const e=t.length-n.length;return e>=0&&t.indexOf(n,e)==e}(r.hostname,".localhost")||/^\/\//.test(t),'%s %s must start with "https://" or "//" or be relative and served from either https or from localhost. Invalid value: %s',n,e,t)}(this.Ij.value,this.Ij.target,"attributes mutation")}catch(t){return w().error("amp-experiment attribute-mutation-default-url",t.message),!1}return!0}mutate(){this.L.forEach((t=>{const n=this.Ij.attributeName,e=this.Ij.value;if(t.setAttribute(n,e),"function"==typeof t.mutatedAttributesCallback){const r=o();r[n]=e,t.mutatedAttributesCallback(r)}}))}toString(){return JSON.stringify(this.Ij)}}(r,e);else{if("class"!==r.attributeName)throw new Error(`Mutation ${JSON.stringify(r)} has an unsupported attributeName.`);i=new class{constructor(t,n){this.Ij=t,this.L=n,K(this.Ij)}parseAndValidate(){return!this.Ij.value.match(/(^|\\W)i-amphtml-/)}mutate(){this.L.forEach((t=>{t.setAttribute(this.Ij.attributeName,this.Ij.value)}))}toString(){return JSON.stringify(this.Ij)}}(r,e)}else w().error(it,"childList mutations not supported in the current experiment state."),i={parseAndValidate:()=>!0,mutate:()=>{}};n.push(i)})),n}(n);u.forEach((t=>{P(t.parseAndValidate(),"Mutation %s has an an unsupported value.",t.toString())})),u.forEach((t=>{t.mutate()}))}))}(this.getAmpDoc(),r,u).then((()=>u));return n.init(t),t})).catch((t=>{throw n.init(Promise.resolve(this.Ej(r))),t}))}catch(t){throw n.init(Promise.resolve({})),t}}))}zA(){const{children:t}=this.element;return P(1==t.length&&"SCRIPT"==t[0].tagName&&"APPLICATION/JSON"==t[0].getAttribute("type").toUpperCase(),'<amp-experiment> should contain exactly one <script type="application/json"> child.'),A(c(t[0].textContent))}Ej(t){const n=Object.create(null);return Object.keys(t).map((t=>{n[t]=null})),n}_j(){return function(t,e){const r=function(t){var e,r,i,s,a;if(t[$])return t[$];t[$]=o();const l=t[$];u(l);const p=f(f({},null!==(e=t.AMP_CONFIG)&&void 0!==e?e:{}),null!==(r=t.AMP_EXP)&&void 0!==r?r:c((null===(i=t.__AMP_EXP)||void 0===i?void 0:i.textContent)||"{}"));for(const t in p){const n=p[t];"number"==typeof n&&n>=0&&n<=1&&(l[t]=Math.random()<n)}const d=null===(s=t.AMP_CONFIG)||void 0===s?void 0:s["allow-doc-opt-in"];if(n(d)&&d.length){const n=t.document.head.querySelector('meta[name="amp-experiments-opt-in"]');if(n){var v;const t=(null===(v=n.getAttribute("content"))||void 0===v?void 0:v.split(","))||[];for(const n of t)d.includes(n)&&(l[n]=!0)}}Object.assign(l,function(t){var n;let e="";try{var r;"localStorage"in t&&(e=null!==(r=t.localStorage.getItem("amp-experiment-toggles"))&&void 0!==r?r:"")}catch(t){}const i=(null===(n=e)||void 0===n?void 0:n.split(/\s*,\s*/g))||[],s=o();for(const t of i)t&&("-"==t[0]?s[t.substr(1)]=!1:s[t]=!0);return s}(t));const b=null===(a=t.AMP_CONFIG)||void 0===a?void 0:a["allow-url-opt-in"];if(n(b)&&b.length){const n=function(t){const n=o();if(!t)return n;let e;for(;e=h.exec(t);){const t=m(e[1],e[1]),r=e[2]?m(e[2].replace(/\+/g," "),e[2]):"";n[t]=r}return n}(t.location.originalHash||t.location.hash);for(const t of b){const e=n[`e-${t}`];"1"==e&&(l[t]=!0),"0"==e&&(l[t]=!1)}}return l}(t);return!!r["amp-experiment-1.0"]}(this.win)?Promise.resolve(!0):(F(this.getAmpDoc()),(t=this.element,M(t,"origin-experiments")).getExperiments().then((t=>t&&t.includes("amp-experiment-1.0"))));var t}};t.registerServiceForDoc("variant",class{constructor(t){this.ampdoc=t,this.kj=new O}init(t){t.then((t=>this.kj.resolve(t)))}getVariants(){return this.kj.promise}whenReady(){return this.getVariants()}}),t.registerElement(at,lt)})();
/*! https://mths.be/cssescape v1.5.1 by @mathias | MIT license */}});
//# sourceMappingURL=amp-experiment-1.0.mjs.map