;
(()=>{var s="amp-viewer-messaging",e="channelOpen",t="__AMPHTML__";function n(s){if("string"!=typeof s)return s;if("{"!=s.charAt(0))return null;try{return JSON.parse(s)}catch(s){return null}}var i=class{static initiateHandshakeWithDocument(s,r){return new Promise((h=>{const a=setInterval((()=>{const o=new MessageChannel,l={app:t,name:"handshake-poll"};s.postMessage(l,"*",[o.port2]);const c=o.port1,u=s=>{const o=n(s.data);if(o&&o.app===t&&o.name===e){clearInterval(a),c.removeEventListener("message",u);const s=new i(null,c,!1,r,!0);s.t(o.requestid,e,null),h(s)}};c.addEventListener("message",u),c.start()}),1e3)}))}static waitForHandshakeFromDocument(s,r,h,a,o){return new Promise((l=>{const c=u=>{const d=n(u.data);if(d&&(u.origin==h||o&&o.test(u.origin))&&(!u.source||u.source==r)&&d.app===t&&d.name===e){s.removeEventListener("message",c);const t=new class{constructor(s,e,t){this.i=s,this.h=e,this.o=t}addEventListener(s,e){this.i.addEventListener("message",(s=>{s.origin==this.h&&s.source==this.o&&e(s)}))}postMessage(s){const e="null"===this.h?"*":this.h;this.o.postMessage(s,e)}start(){}}(s,u.origin,r),n=new i(null,t,!1,a,!0);n.t(d.requestid,e,null),l(n)}};s.addEventListener("message",c)}))}constructor(s,e,t,n,i){this.i=s,this.l=e,this.u=!!t,this._=n||null,this.p=!!i,this.g=0,this.m={},this.P={},this.A=null,this.l.addEventListener("message",this.R.bind(this)),this.l.start()}registerHandler(s,e){this.P[s]=e}unregisterHandler(s){delete this.P[s]}setDefaultHandler(s){this.A=s}R(e){const i=n(e.data);i&&i.app===t&&(this._&&this.p&&i.messagingToken!==this._?this.M(s+": handleMessage_ error: ","invalid token"):"q"===i.type?this.q(i):"s"===i.type&&this.v(i))}sendRequest(s,e,n){const i=++this.g;let r;return n&&(r=new Promise(((s,e)=>{this.m[i]={resolve:s,reject:e}}))),this.I({app:t,requestid:i,type:"q",name:s,data:e,rsvp:n}),r}t(s,e,n){this.I({app:t,requestid:s,type:"s",name:e,data:n})}T(e,n,i){const r=this.V(i);this.M(s+": sendResponseError_, message name: "+n,r),this.I({app:t,requestid:e,type:"s",name:n,data:null,error:r})}I(s){const e=Object.assign(s,{});this._&&!this.p&&(e.messagingToken=this._),this.l.postMessage(this.u?JSON.stringify(e):e)}q(s){let e=this.P[s.name];if(e||(e=this.A),!e){const e=new Error("Cannot handle request because no default handler is set!");throw e.args=s.name,e}const t=e(s.name,s.data,!!s.rsvp);if(s.rsvp){const e=s.requestid;if(!t)throw this.T(e,s.name,new Error("no response")),new Error("expected response but none given: "+s.name);t.then((t=>{this.t(e,s.name,t)}),(t=>{this.T(e,s.name,t)}))}}v(e){const t=e.requestid,n=this.m[t];n&&(delete this.m[t],e.error?(this.M(s+": handleResponse_ error: ",e.error),n.reject(new Error(`Request ${e.name} failed: ${e.error}`))):n.resolve(e.data))}M(s,e){if(!this.i)return;let t="amp-messaging-error-logger: "+s;t+=" data: "+this.V(e),this.i.viewerState=t}V(s){return s?s.message?s.message:String(s):"unknown error"}};self.AmpViewerHost=class{constructor(s,e,t,n,r,h,a){this.win=s,this.H=e,this.k=n,this.u=!!h,this.logsId=r;const o=this.H.contentWindow;this.u||a?i.initiateHandshakeWithDocument(o).then((s=>{this.S=s,this.O()})):i.waitForHandshakeFromDocument(this.win,o,t).then((s=>{this.S=s,this.O()}))}O(){this.S.setDefaultHandler(this.k),this.sendRequest("visibilitychange",{state:this.D,prerenderSize:this.prerenderSize},!0)}sendRequest(s,e,t){if(this.log("sendRequest"),this.S)return this.S.sendRequest(s,e,t)}log(){const s=Array.prototype.slice.call(arguments,0);s.unshift("[ViewerHost "+this.logsId+"]"),console.log.apply(console,s)}}})();
//# sourceMappingURL=amp-viewer-host.mjs.map