;
!function(){var t="amp-viewer-messaging",n="channelOpen",i="__AMPHTML__";function e(t){if("string"!=typeof t)return t;if("{"!=t.charAt(0))return null;try{return JSON.parse(t)}catch(t){return null}}var s=function(){function t(t,n,i){this.t=t,this.i=n,this.h=i}var n=t.prototype;return n.addEventListener=function(t,n){var i=this;this.t.addEventListener("message",(function(t){t.origin==i.i&&t.source==i.h&&n(t)}))},n.postMessage=function(t){var n="null"===this.i?"*":this.i;this.h.postMessage(t,n)},n.start=function(){},t}(),r=function(){function r(t,n,i,e,s){this.t=t,this.o=n,this.u=!!i,this.l=e||null,this.v=!!s,this.p=0,this.g={},this.m={},this.q=null,this.o.addEventListener("message",this._.bind(this)),this.o.start()}r.initiateHandshakeWithDocument=function(t,s){return new Promise((function(h){var a=setInterval((function(){var o=new MessageChannel,u={app:i,name:"handshake-poll"};t.postMessage(u,"*",[o.port2]);var f=o.port1;f.addEventListener("message",(function t(o){var u=e(o.data);if(u&&u.app===i&&u.name===n){clearInterval(a),f.removeEventListener("message",t);var c=new r(null,f,!1,s,!0);c.M(u.requestid,n,null),h(c)}})),f.start()}),1e3)}))},r.waitForHandshakeFromDocument=function(t,h,a,o,u){return new Promise((function(f){t.addEventListener("message",(function c(l){var v=e(l.data);if(v&&(l.origin==a||u&&u.test(l.origin))&&(!l.source||l.source==h)&&v.app===i&&v.name===n){t.removeEventListener("message",c);var p=new r(null,new s(t,l.origin,h),!1,o,!0);p.M(v.requestid,n,null),f(p)}}))}))};var h=r.prototype;return h.registerHandler=function(t,n){this.m[t]=n},h.unregisterHandler=function(t){delete this.m[t]},h.setDefaultHandler=function(t){this.q=t},h._=function(n){var s=e(n.data);s&&s.app===i&&(this.l&&this.v&&s.messagingToken!==this.l?this.O(t+": handleMessage_ error: ","invalid token"):"q"===s.type?this.P(s):"s"===s.type&&this.R(s))},h.sendRequest=function(t,n,e){var s=this,r=++this.p,h=void 0;return e&&(h=new Promise((function(t,n){s.g[r]={resolve:t,reject:n}}))),this.S({app:i,requestid:r,type:"q",name:t,data:n,rsvp:e}),h},h.M=function(t,n,e){this.S({app:i,requestid:t,type:"s",name:n,data:e})},h.k=function(n,e,s){var r=this.j(s);this.O(t+": sendResponseError_, message name: "+e,r),this.S({app:i,requestid:n,type:"s",name:e,data:null,error:r})},h.S=function(t){var n=Object.assign(t,{});this.l&&!this.v&&(n.messagingToken=this.l),this.o.postMessage(this.u?JSON.stringify(n):n)},h.P=function(t){var n=this,i=this.m[t.name];if(i||(i=this.q),!i){var e=new Error("Cannot handle request because no default handler is set!");throw e.args=t.name,e}var s=i(t.name,t.data,!!t.rsvp);if(t.rsvp){var r=t.requestid;if(!s)throw this.k(r,t.name,new Error("no response")),new Error("expected response but none given: "+t.name);s.then((function(i){n.M(r,t.name,i)}),(function(i){n.k(r,t.name,i)}))}},h.R=function(n){var i=n.requestid,e=this.g[i];e&&(delete this.g[i],n.error?(this.O(t+": handleResponse_ error: ",n.error),e.reject(new Error("Request ".concat(n.name," failed: ").concat(n.error)))):e.resolve(n.data))},h.O=function(t,n){if(this.t){var i="amp-messaging-error-logger: "+t;i+=" data: "+this.j(n),this.t.viewerState=i}},h.j=function(t){return t?t.message?t.message:String(t):"unknown error"},r}(),h=function(){function t(t,n,i,e,s,h,a){var o=this;this.win=t,this.A=n,this.C=e,this.u=!!h,this.logsId=s;var u=this.A.contentWindow;this.u||a?r.initiateHandshakeWithDocument(u).then((function(t){o.H=t,o.I()})):r.waitForHandshakeFromDocument(this.win,u,i).then((function(t){o.H=t,o.I()}))}var n=t.prototype;return n.I=function(){this.H.setDefaultHandler(this.C),this.sendRequest("visibilitychange",{state:this.J,prerenderSize:this.prerenderSize},!0)},n.sendRequest=function(t,n,i){if(this.log("sendRequest"),this.H)return this.H.sendRequest(t,n,i)},n.log=function(){var t=Array.prototype.slice.call(arguments,0);t.unshift("[ViewerHost "+this.logsId+"]"),console.log.apply(console,t)},t}();self.AmpViewerHost=h}();
//# sourceMappingURL=amp-viewer-host.js.map